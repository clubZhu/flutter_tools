# 抖音视频解析测试指南

## 已修复的问题 ✅

1. **短链接处理** - 添加了抖音短链接展开功能
2. **API兼容性** - 优化了对TikWM API的调用
3. **错误日志** - 添加了详细的调试日志
4. **多重解析** - 实现了多种解析方式的降级策略

---

## 抖音链接格式

### 支持的链接格式

#### 完整链接
```
https://www.douyin.com/video/7123456789012345678
https://www.iesdouyin.com/share/video/7123456789012345678
```

#### 短链接
```
https://v.douyin.com/jkF8xY/
```

#### 分享文本
```
这是一段精彩的视频！
https://v.douyin.com/jkF8xY/
复制此链接，打开【抖音】即可观看
```

---

## 测试步骤

### 1. 获取抖音视频链接

#### 方法A：从抖音App复制
1. 打开抖音App
2. 找到想要下载的视频
3. 点击"分享"按钮
4. 选择"复制链接"

#### 方法B：从分享文本提取
```
抖音视频示例：
https://v.douyin.com/jkF8xY/
6.24 HrR 发布了一支视频，快来围观！
```

### 2. 在应用中解析

1. 打开应用的"视频下载"页面
2. 粘贴抖音链接
3. 点击"解析视频"
4. 等待解析完成

### 3. 查看解析结果

成功后会显示：
- 视频标题
- 作者名称
- 视频封面
- 视频预览

### 4. 下载视频

- 点击"下载视频"按钮
- 首次使用会请求存储权限
- 等待下载完成
- 查看存储位置

---

## 常见错误及解决

### 错误1：解析失败 - "链接无效"

**原因**：
- 链接格式不正确
- 视频已被删除
- 链接已过期

**解决方法**：
1. 重新从抖音App复制链接
2. 确保链接完整，没有被截断
3. 尝试其他视频

### 错误2：API返回错误

**原因**：
- TikWM API暂时不可用
- 请求频率过高被限制
- 网络连接问题

**解决方法**：
1. 等待几秒后重试
2. 检查网络连接
3. 切换到更稳定的网络（WiFi）

### 错误3：获取不到视频URL

**原因**：
- API返回的数据格式变化
- 视频有特殊限制

**解决方法**：
1. 查看控制台日志
2. 尝试其他视频
3. 联系技术支持

---

## 调试功能

### 查看详细日志

运行应用时启用详细日志：
```bash
flutter run -v
```

关键日志信息：
```
检测到抖音链接，使用专用解析方法
直接使用TikWM API解析: [URL]
API响应状态: 200
TikWM API响应: {code: 0, data: {...}}
最终视频URL: [视频地址]
```

### 测试链接

#### 有效测试链接（需要从抖音App获取真实链接）

#### 通用测试视频（用于验证下载功能）
```
https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10MB_5mb.mp4
```

---

## 技术细节

### 短链接展开流程

1. **检测短链接** - 识别 v.douyin.com
2. **展开短链接** - 通过HTTP请求获取完整URL
3. **API解析** - 使用TikWM API解析
4. **数据提取** - 提取视频信息

### API字段映射

抖音API响应字段：
```dart
{
  "code": 0,
  "data": {
    "id": "视频ID",
    "title": "视频标题",
    "desc": "视频描述",
    "cover": "封面图URL",
    "play": "无水印视频URL",
    "hdplay": "高清视频URL",
    "author": {
      "nickname": "作者名称"
    }
  }
}
```

### 降级策略

1. 标准解析 → 2. 短链接展开 → 3. 直接API解析 → 4. 返回失败

---

## 优化建议

### 已实现 ✅

1. ✅ 短链接展开
2. ✅ 多种API字段支持
3. ✅ 详细错误日志
4. ✅ 降级解析策略
5. ✅ User-Agent伪装

### 待优化

1. 添加备用API服务
2. 实现链接缓存
3. 添加批量下载功能
4. 支持下载历史记录

---

## 测试清单

解析成功的标志：
- [ ] 可以识别抖音链接
- [ ] 短链接可以展开
- [ ] API返回正确的数据
- [ ] 显示视频标题
- [ ] 显示作者信息
- [ ] 显示封面图
- [ ] 视频可以预览播放
- [ ] 视频可以下载

---

## 成功案例

### 示例1：短链接解析
```
输入: https://v.douyin.com/jkF8xY/
输出:
  标题: [视频标题]
  作者: [作者名称]
  封面: [封面URL]
  视频: [视频URL]
```

### 示例2：完整链接解析
```
输入: https://www.douyin.com/video/7123456789012345678
输出:
  标题: [视频标题]
  作者: [作者名称]
  封面: [封面URL]
  视频: [视频URL]
```

---

## 限制说明

### TikWM API 限制
- 每天免费100次请求
- 单次请求最多30秒
- 不支持私密视频
- 不支持直播回放

### 抖音平台限制
- 部分视频有地区限制
- 私密视频无法解析
- 链接有时效性

---

## 使用建议

1. **及时下载** - 解析后尽快下载，避免链接过期
2. **检查链接** - 确保链接完整，没有被截断
3. **稳定网络** - 使用WiFi等稳定网络
4. **更新应用** - 保持应用最新版本

---

**更新日期**: 2024-01-20
**版本**: v1.2
**状态**: ✅ 已修复抖音解析问题
